<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>PEA ‡∏ô‡∏Ñ‡∏£‡∏û‡∏ô‡∏° - GECC 2569 MONITORING</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.0.0"></script>
  <style>
    :root { --gecc-blue: #003366; --gecc-gold: #D4AF37; }
    body { background: #f0f2f5; font-family: 'Sarabun', sans-serif; padding-bottom: 110px; }
    .header { background: var(--gecc-blue); color: white; border-bottom: 5px solid var(--gecc-gold); padding: 15px; }
    .filter-section { background: #fff; padding: 15px; border-bottom: 2px solid var(--gecc-gold); position: sticky; top: 0; z-index: 1000; }
    
    /* Dashboard ‡∏ï‡∏±‡∏ß‡∏´‡∏ô‡∏±‡∏á‡∏™‡∏∑‡∏≠‡πÉ‡∏´‡∏ç‡πà‡∏û‡∏¥‡πÄ‡∏®‡∏© (‡∏ï‡∏≤‡∏°‡∏Ñ‡∏≥‡∏™‡∏±‡πà‡∏á) */
    .stat-card { background: white; border-top: 6px solid var(--gecc-gold); border-radius: 20px; padding: 25px 10px; text-align: center; box-shadow: 0 8px 20px rgba(0,0,0,0.12); height: 100%; }
    .stat-card b { font-size: 1.3rem !important; color: var(--gecc-blue); display: block; margin-bottom: 10px; }
    .stat-value { font-size: 3.5rem !important; font-weight: 900; line-height: 1; }
    .dept-card b { font-size: 1.3rem !important; color: var(--gecc-blue); display: block; }
    .dept-info { font-size: 1.2rem !important; font-weight: bold; }

    /* Table & Scroller */
    .table-wrap { max-height: 1200px; overflow-y: auto; background: white; border-radius: 10px; border: 1px solid #ddd; }
    thead th { position: sticky; top: 0; background: var(--gecc-blue) !important; color: white !important; z-index: 20; padding: 12px !important; }

    /* Hover Preview ‡∏Å‡∏•‡∏≤‡∏á‡∏à‡∏≠ (‡∏ß‡∏¥‡∏ò‡∏µ‡∏ó‡∏µ‡πà‡∏Ñ‡∏∏‡∏ì‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥) */
    .preview-box { color: var(--gecc-blue); text-decoration: underline; cursor: pointer; font-weight: bold; position: relative; display: inline-block; }
    .preview-box:hover .hover-img-wrap { display: block !important; }
    .hover-img-wrap {
      display: none; position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%);
      width: 450px; background: white; border: 8px solid var(--gecc-gold); 
      border-radius: 20px; z-index: 10000; box-shadow: 0 0 60px rgba(0,0,0,0.8); padding: 10px;
    }
    .hover-img-wrap img { width: 100%; height: auto; border-radius: 10px; }

    .footer { position: fixed; bottom: 0; width: 100%; background: var(--gecc-blue); color: var(--gecc-gold); text-align: center; padding: 10px; font-size: 12px; z-index: 1000; }

/* --- ‡∏ß‡∏≤‡∏á‡πÇ‡∏Ñ‡πâ‡∏î‡∏™‡∏µ‡∏ó‡∏≠‡∏á‡∏ï‡∏£‡∏á‡∏ô‡∏µ‡πâ‡∏Ñ‡∏£‡∏±‡∏ö --- */
  .gold-gradient {
    background: linear-gradient(to bottom, #BF953F, #FCF6BA, #B38728, #FBF5B7, #AA771C);
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
    display: inline-block;
    font-weight: 900;
    font-size: 1rem;
    text-transform: uppercase;
    filter: drop-shadow(0px 2px 2px rgba(0,0,0,0.3));
  }
  /* -------------------------- */

  </style>
</head>
<body>

<div class="header text-center shadow">
  <img id="logo" src="" style="max-height: 65px;">
  <h5 class="fw-bold mt-2 mb-0">
    <span style="color: #ffffff;">PEA NAKHON PHANOM</span><br>
    <span class="gold-gradient">GECC 2569 MONITORING SYSTEM</span>
  </h5>
</div>

<div class="filter-section shadow-sm">
  <div class="container-fluid">
    <div class="d-flex justify-content-between align-items-center" onclick="toggleFilter()" style="cursor: pointer;">
      <span class="fw-bold text-dark"><i class="bi bi-funnel"></i> üîç ‡∏ï‡∏±‡∏ß‡∏Å‡∏£‡∏≠‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</span>
      <span id="filterIcon" class="badge bg-secondary">‡πÄ‡∏õ‡∏¥‡∏î‡∏ï‡∏±‡∏ß‡∏Å‡∏£‡∏≠‡∏á</span>
    </div>

    <div id="filterBody" style="display: none; transition: 0.3s;">
  <div class="row g-2 mt-2 pt-2 border-top">
    <div class="col-6 col-md-3"><label class="fw-bold small">‡∏î‡πâ‡∏≤‡∏ô‡∏´‡∏•‡∏±‡∏Å</label><select id="filterMain" class="form-select form-select-sm" onchange="render()"></select></div>
    <div class="col-6 col-md-3"><label class="fw-bold small">‡∏î‡πâ‡∏≤‡∏ô‡∏¢‡πà‡∏≠‡∏¢</label><select id="filterSub" class="form-select form-select-sm" onchange="render()"></select></div>
    
    <div class="col-6 col-md-3"><label class="fw-bold small">‡πÅ‡∏ú‡∏ô‡∏Å</label><select id="filterDept" class="form-select form-select-sm" onchange="render()"></select></div>
    <div class="col-6 col-md-3"><label class="fw-bold small">‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞</label><select id="filterStatus" class="form-select form-select-sm" onchange="render()"><option value="">‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</option><option value="‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£</option><option value="‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£‡πÅ‡∏•‡πâ‡∏ß">‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£‡πÅ‡∏•‡πâ‡∏ß</option></select></div>
  </div>
</div>
  </div>
</div>

<div class="container-fluid mt-3">
  <div class="row g-3 mb-4 text-center" id="summaryStats"></div>
  
  <h6 class="fw-bold mb-2">
    üìä ‡∏™‡∏£‡∏∏‡∏õ‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏£‡∏≤‡∏¢‡πÅ‡∏ú‡∏ô‡∏Å 
    <span style="font-weight: normal; font-size: 0.9rem;">
      (<span style="color: black;">‡∏á‡∏≤‡∏ô‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</span> / 
       <span style="color: #198754;">‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£‡πÅ‡∏•‡πâ‡∏ß</span> / 
       <span style="color: #dc3545;">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£</span>)
    </span>
  </h6>
<div class="d-flex justify-content-between align-items-center mb-2">
    
    <button class="btn btn-sm btn-outline-primary fw-bold" onclick="showStaffModal()">üìà ‡∏î‡∏π‡∏™‡∏£‡∏∏‡∏õ‡∏£‡∏≤‡∏¢‡∏Ñ‡∏ô</button>
  </div>

  <div class="modal fade" id="staffModal" tabindex="-1">
    <div class="modal-dialog modal-lg modal-dialog-centered">
      <div class="modal-content">
        <div class="modal-header">
          <b class="modal-title">üìä ‡∏™‡∏£‡∏∏‡∏õ‡∏á‡∏≤‡∏ô‡πÅ‡∏¢‡∏Å‡∏ï‡∏≤‡∏°‡∏ú‡∏π‡πâ‡∏£‡∏±‡∏ö‡∏ú‡∏¥‡∏î‡∏ä‡∏≠‡∏ö</b>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          <canvas id="staffChart"></canvas>
        </div>
      </div>
    </div>
  </div>
  <div id="deptStats" class="row g-2 mb-4"></div>
</div>

  <div class="table-wrap mb-4 shadow-sm">
    <table class="table table-hover table-sm mb-0">
      <thead>
        <tr><th>‡πÄ‡∏Å‡∏ì‡∏ë‡πå</th><th>‡∏Ç‡πâ‡∏≠‡∏õ‡∏£‡∏∞‡πÄ‡∏°‡∏¥‡∏ô</th><th>‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô</th><th>Emoji</th><th>‡πÅ‡∏ú‡∏ô‡∏Å</th><th>‡∏ú‡∏π‡πâ‡∏£‡∏±‡∏ö‡∏ú‡∏¥‡∏î‡∏ä‡∏≠‡∏ö</th><th>‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞</th><th>‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡πÄ‡∏™‡∏£‡πá‡∏à</th><th>‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£‡πÅ‡∏ô‡∏ö</th><th>‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£</th></tr>
      </thead>
      <tbody id="tableBody"></tbody>
    </table>
  </div>
</div>
<div class="container-fluid mb-5">
<div style="position: fixed; bottom: 0; left: 0; width: 100%; z-index: 1000; background: var(--gecc-blue); border-top: 2px solid var(--gecc-gold);">
  
  <div class="d-flex justify-content-center gap-2 p-2" style="background: rgba(255,255,255,0.1);">
    <a href="https://drive.google.com/drive/u/0/folders/1TPPSZnhZcJP_xPYh5zULeP1HoV90PvFk" target="_blank" class="btn btn-sm btn-warning fw-bold shadow-sm" style="border-radius: 5px; flex: 1; max-width: 150px; font-size: 0.75rem;">
      üìÑ ‡πÅ‡∏ö‡∏ö‡∏ü‡∏≠‡∏£‡πå‡∏°
    </a>
    <a href="https://drive.google.com/drive/u/0/folders/1TPPSZnhZcJP_xPYh5zULeP1HoV90PvFk" target="_blank" class="btn btn-sm btn-info text-white fw-bold shadow-sm" style="border-radius: 5px; flex: 1; max-width: 150px; font-size: 0.75rem; background-color: #17a2b8;">
      üìö ‡∏Ñ‡∏π‡πà‡∏°‡∏∑‡∏≠
    </a>
  </div>

  <div class="text-center" style="color: var(--gecc-gold); font-size: 12px; padding: 5px 0;">
    ‡∏ú‡∏π‡πâ‡∏û‡∏±‡∏í‡∏ô‡∏≤: ‡∏ô‡∏≤‡∏¢‡∏®‡∏∏‡∏†‡∏Å‡∏§‡∏© ‡∏ó‡∏∞‡∏ß‡∏±‡∏á ‡∏ä‡∏ú.‡∏ö‡∏™.‡∏Å‡∏ü‡∏à.‡∏ô‡∏û.
  </div>
</div>

<div class="modal fade" id="editModal" tabindex="-1" data-bs-backdrop="static">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content border-0 shadow-lg">
      <div class="modal-header text-white" style="background:var(--gecc-blue);"><h6 id="mTitle" class="mb-0"></h6><button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button></div>
      <form id="editForm">
        <div class="modal-body">
          <input type="hidden" id="mRowId"><input type="hidden" id="mOldUrl"><input type="hidden" id="mMainCat"><input type="hidden" id="mTopicName">
          <div class="mb-3"><label class="small fw-bold">‡πÅ‡∏ú‡∏ô‡∏Å‡∏ó‡∏µ‡πà‡∏£‡∏±‡∏ö‡∏ú‡∏¥‡∏î‡∏ä‡∏≠‡∏ö</label><select id="mDept" class="form-select" required></select></div>
          <div class="mb-3"><label class="small fw-bold">‡∏ú‡∏π‡πâ‡∏£‡∏±‡∏ö‡∏ú‡∏¥‡∏î‡∏ä‡∏≠‡∏ö</label><input type="text" id="mStaff" class="form-control" required></div>
          <div class="mb-3"><label class="small fw-bold">‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞</label><select id="mStatus" class="form-select"><option value="‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£</option><option value="‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£‡πÅ‡∏•‡πâ‡∏ß">‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£‡πÅ‡∏•‡πâ‡∏ß</option></select></div>
          <div class="mb-3"><label class="small fw-bold">‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡πÄ‡∏™‡∏£‡πá‡∏à</label><input type="date" id="mDeadline" class="form-control"></div>
          <div class="mb-3"><label class="small fw-bold">‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡∏´‡∏•‡∏±‡∏Å‡∏ê‡∏≤‡∏ô</label><input type="file" id="mFile" class="form-control" accept="image/*,application/pdf"></div>
        </div>
        <div class="modal-footer border-0"><button type="submit" class="btn btn-lg w-100 text-white shadow" style="background:var(--gecc-blue)">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</button></div>
      </form>
    </div>
  </div>
</div>

<div class="modal fade" id="viewTextModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-xl modal-dialog-centered">
    <div class="modal-content border-0 shadow-lg" style="border-radius: 20px;">
      <div class="modal-header text-white" style="background:var(--gecc-blue); border-radius: 20px 20px 0 0;">
        <h5 class="modal-title fw-bold">üîç ‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏Ç‡πâ‡∏≠‡∏õ‡∏£‡∏∞‡πÄ‡∏°‡∏¥‡∏ô (‡∏â‡∏ö‡∏±‡∏ö‡πÄ‡∏ï‡πá‡∏°)</h5>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body p-5">
        <div id="fullTextContent" class="fs-3 fw-normal text-dark" style="line-height: 1.6; white-space: pre-wrap;"></div>
      </div>
      <div class="modal-footer border-0">
        <button type="button" class="btn btn-secondary px-5" data-bs-dismiss="modal">‡∏õ‡∏¥‡∏î‡∏´‡∏ô‡πâ‡∏≤‡∏ï‡πà‡∏≤‡∏á</button>
      </div>
    </div>
  </div>
</div>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script>
  // ** ‡∏Å‡πä‡∏≠‡∏õ‡∏õ‡∏µ‡πâ URL ‡∏ó‡∏µ‡πà Deploy ‡πÑ‡∏î‡πâ‡∏à‡∏≤‡∏Å GAS ‡∏°‡∏≤‡∏ß‡∏≤‡∏á‡∏ó‡∏µ‡πà‡∏ô‡∏µ‡πà **
  const WEB_APP_URL = 'https://script.google.com/macros/s/AKfycbzq_NPd0ieK9xSzLUlqeRG-S0JdJ9_kn2irRUCMYg_pHjE7liRdkAc0hZzs14PyoFjDfw/exec'; 

  let db = [];
  const modal = new bootstrap.Modal(document.getElementById('editModal'));

  // ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç: ‡πÉ‡∏ä‡πâ‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö‡∏•‡∏¥‡∏á‡∏Å‡πå‡∏ï‡∏≤‡∏°‡∏ó‡∏µ‡πà‡∏Ñ‡∏∏‡∏ì‡πÄ‡∏™‡∏ô‡∏≠ (‡∏î‡∏∂‡∏á File ID ‡∏°‡∏≤‡πÉ‡∏™‡πà)
function getDirectImg(url) {
  if(!url || url === '-') return '';
  let fileId = '';

  // ‡∏™‡∏Å‡∏±‡∏î ID ‡∏≠‡∏≠‡∏Å‡∏°‡∏≤‡πÉ‡∏´‡πâ‡∏ä‡∏±‡∏ß‡∏£‡πå 100% ‡πÑ‡∏°‡πà‡∏ß‡πà‡∏≤‡∏•‡∏¥‡∏á‡∏Å‡πå‡∏à‡∏∞‡∏°‡∏≤‡πÅ‡∏ö‡∏ö /file/d/ ‡∏´‡∏£‡∏∑‡∏≠ ?id=
  try {
    if (url.includes('id=')) {
      fileId = url.split('id=')[1].split('&')[0];
    } else if (url.includes('/d/')) {
      fileId = url.split('/d/')[1].split('/')[0];
    }
  } catch (e) { return ''; }

  if (!fileId) return '';

  // ‡πÉ‡∏ä‡πâ‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö googleusercontent ‡∏ó‡∏µ‡πà‡πÄ‡∏™‡∏ñ‡∏µ‡∏¢‡∏£‡∏ó‡∏µ‡πà‡∏™‡∏∏‡∏î 
  // ‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö‡∏ô‡∏µ‡πâ‡∏à‡∏∞‡∏ö‡∏±‡∏á‡∏Ñ‡∏±‡∏ö‡πÉ‡∏´‡πâ Google ‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏†‡∏≤‡∏û‡∏≠‡∏≠‡∏Å‡∏°‡∏≤‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏•‡∏Ç‡πâ‡∏≤‡∏á‡∏ô‡∏≠‡∏Å‡πÑ‡∏î‡πâ‡∏Ñ‡∏£‡∏±‡∏ö
  return "https://lh3.googleusercontent.com/d/" + fileId;
}

  // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏î‡∏∂‡∏á‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏î‡∏¥‡∏°‡∏à‡∏≤‡∏Å‡∏ä‡∏µ‡∏ï (‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö DD/MM/YYYY) ‡πÅ‡∏•‡∏∞‡πÅ‡∏õ‡∏•‡∏á‡πÄ‡∏õ‡πá‡∏ô YYYY-MM-DD
  function parseDateForInput(dateStr) {
    if (!dateStr || dateStr === '-' || dateStr === '') return '';
    const match = dateStr.match(/(\d{1,2})\/(\d{1,2})\/(\d{4})/);
    if (match) {
      let d = match[1].padStart(2, '0');
      let m = match[2].padStart(2, '0');
      let y = parseInt(match[3]);
      if (y > 2500) y -= 543;
      return `${y}-${m}-${d}`;
    }
    return '';
  }

  async function loadData() {
    Swal.fire({ title: '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•...', allowOutsideClick: false, didOpen: () => Swal.showLoading() });
    try {
      const response = await fetch(`${WEB_APP_URL}?action=getData`);
      db = await response.json();
      if(db.status === "success") { setup(); Swal.close(); }
    } catch (e) { Swal.fire('Error', '‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö URL ‡∏Ç‡∏≠‡∏á Web App', 'error'); }
  }

  function setup() {
    document.getElementById('logo').src = db.config.logo_url || "";
    const depts = (db.config.dept_list || "").split(',');
    const deptHtml = depts.map(d => `<option value="${d.trim()}">${d.trim()}</option>`).join('');
    document.getElementById('mDept').innerHTML = deptHtml;
    document.getElementById('filterDept').innerHTML = '<option value="">‡πÅ‡∏ú‡∏ô‡∏Å‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</option>' + deptHtml;
    
    const criteriaRows = db.criteria.slice(1);
    const mains = [...new Set(criteriaRows.map(r => r[0]))].filter(x => x);
    document.getElementById('filterMain').innerHTML = '<option value="">‡πÄ‡∏Å‡∏ì‡∏ë‡πå‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</option>' + mains.map(m => `<option value="${m}">${m}</option>`).join('');

    // ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Å‡∏≤‡∏£‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏î‡πâ‡∏≤‡∏ô‡∏¢‡πà‡∏≠‡∏¢ (‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå B ‡∏Ñ‡∏∑‡∏≠ index 1)
    const subs = [...new Set(criteriaRows.map(r => r[1]))].filter(x => x);
    document.getElementById('filterSub').innerHTML = '<option value="">‡∏î‡πâ‡∏≤‡∏ô‡∏¢‡πà‡∏≠‡∏¢‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</option>' + subs.map(s => `<option value="${s}">${s}</option>`).join('');
    
    render();
  }

function render() {
    // ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Å‡∏≤‡∏£‡∏£‡∏±‡∏ö‡∏Ñ‡πà‡∏≤‡∏à‡∏≤‡∏Å filterSub
    const fMain = document.getElementById('filterMain').value, 
          fSub = document.getElementById('filterSub').value, // ‡∏£‡∏±‡∏ö‡∏Ñ‡πà‡∏≤‡∏î‡πâ‡∏≤‡∏ô‡∏¢‡πà‡∏≠‡∏¢
          fDept = document.getElementById('filterDept').value, 
          fStatus = document.getElementById('filterStatus').value;
          
    const tbody = document.getElementById('tableBody'); tbody.innerHTML = '';
    let cAll = 0, sAll = 0, cDone = 0, sDone = 0, cPend = 0, sPend = 0, deptMap = {};

    db.criteria.slice(1).forEach((r, idx) => {
      const status = (r[7] || "").trim();
      
      // ‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏á‡∏∑‡πà‡∏≠‡∏ô‡πÑ‡∏Ç (!fSub || r[1] === fSub) ‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö match
      const match = (!fMain || r[0] === fMain) && 
                    (!fSub || r[1] === fSub) && 
                    (!fDept || r[5] === fDept) && 
                    (!fStatus || status === fStatus);
      
      const isDone = status === '‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£‡πÅ‡∏•‡πâ‡∏ß';
      
      if(r[5]){
        const dName = r[5].trim();
        if(!deptMap[dName]) deptMap[dName] = {t:0, d:0, p:0};
        deptMap[dName].t++; isDone ? deptMap[dName].d++ : deptMap[dName].p++;
      }
      if(match) {
        cAll++; sAll += Number(r[3])||0;
        isDone ? (cDone++, sDone += Number(r[3])||0) : (cPend++, sPend += Number(r[3])||0);
        tbody.innerHTML += `
          <tr>
            <td class="small text-muted">${r[0]}</td>
<td class="fw-bold text-primary" style="cursor: pointer;" onclick="showFullText(\`${r[2]}\`)">
      ${r[2]}</td>            
            <td class="text-center">${r[3]}</td><td class="text-center fs-5">${r[4]}</td>
            <td class="text-center">${r[5]||'-'}</td><td>${r[6]||'-'}</td>
            <td class="text-center"><span class="badge ${isDone?'bg-success':'bg-warning text-dark'}">${status || '‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£'}</span></td>
            <td class="text-center">${r[8]||'-'}</td>
            <td class="text-center">
              ${r[9] ? `<div class="preview-box">
                <span onclick="window.open('${r[9]}')">‡∏î‡∏π‡πÑ‡∏ü‡∏•‡πå</span>
                <div class="hover-img-wrap"><img src="${getDirectImg(r[9])}" onerror="this.src='https://via.placeholder.com/450x300?text=PDF+File'"></div>
              </div>` : '-'}
            </td>
            <td class="text-center"><button class="btn btn-sm btn-outline-primary" onclick="openEdit(${idx+2})">Edit</button></td>
          </tr>`;
      }
    });

    document.getElementById('summaryStats').innerHTML = `
      <div class="col-6 col-md-3"><div class="stat-card"><b>‡∏á‡∏≤‡∏ô‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</b><div class="stat-value text-dark">${cAll}</div><small>(${sAll} ‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô)</small></div></div>
     	 <div class="col-6 col-md-3"><div class="stat-card"><b class="text-success">‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£‡πÅ‡∏•‡πâ‡∏ß</b><div class="stat-value text-success">${cDone}</div><small class="text-muted">(${sDone} ‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô)</small></div></div>
	<div class="col-6 col-md-3"><div class="stat-card"><b class="text-danger">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£</b><div class="stat-value text-danger">${cPend}</div><small class="text-muted">(${sPend} ‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô)
</small></div></div>
      <div class="col-6 col-md-3"><div class="stat-card"><b class="text-primary">‡∏Å‡πâ‡∏≤‡∏ß‡∏´‡∏ô‡πâ‡∏≤</b><div class="stat-value text-primary">${Math.round(cDone/cAll*100||0)}%</div></div></div>`;

    document.getElementById('deptStats').innerHTML = Object.keys(deptMap).map(d => `
      <div class="col-md-3 col-6"><div class="dept-card"><b>${d}</b><div class="dept-info">${deptMap[d].t} / <span class="text-success">${deptMap[d].d}</span> / <span class="text-danger">${deptMap[d].p}</span></div></div></div>`).join('');
  }

  function openEdit(id) {
  // ‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÅ‡∏ñ‡∏ß‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç
  const r = db.criteria[id-1];
  
  // ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏û‡∏∑‡πâ‡∏ô‡∏ê‡∏≤‡∏ô‡∏≠‡∏∑‡πà‡∏ô‡πÜ
  document.getElementById('mRowId').value = id;
  document.getElementById('mTitle').innerText = r[2];
  document.getElementById('mDept').value = r[5] || '';
  document.getElementById('mStaff').value = r[6] || '';
  document.getElementById('mStatus').value = (r[7] || "").trim() || '‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£';
  
  // --- ‡∏™‡πà‡∏ß‡∏ô‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà (‡πÅ‡∏ö‡∏ö‡πÄ‡∏ô‡πâ‡∏ô‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ä‡∏±‡∏ß‡∏£‡πå) ---
  let sheetDate = r[8]; 
  let dateForInput = "";

  if (sheetDate && sheetDate !== "-" && sheetDate !== "") {
    try {
      // 1. ‡∏•‡∏≠‡∏á‡∏Å‡∏£‡∏ì‡∏µ‡∏ó‡∏µ‡πà‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏°‡∏≤‡πÄ‡∏õ‡πá‡∏ô‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö ‡∏ß‡∏±‡∏ô/‡πÄ‡∏î‡∏∑‡∏≠‡∏ô/‡∏õ‡∏µ
      const parts = sheetDate.split('/');
      if (parts.length === 3) {
        let d = parts[0].trim().padStart(2, '0');
        let m = parts[1].trim().padStart(2, '0');
        let y = parseInt(parts[2].trim());

        // ‡∏ñ‡πâ‡∏≤‡∏õ‡∏µ‡πÄ‡∏õ‡πá‡∏ô ‡∏û.‡∏®. (‡πÄ‡∏Å‡∏¥‡∏ô 2500) ‡πÉ‡∏´‡πâ‡∏•‡∏ö 543
        if (y > 2500) y -= 543;
        
        // ‡∏ñ‡πâ‡∏≤‡∏õ‡∏µ‡πÄ‡∏õ‡πá‡∏ô‡πÄ‡∏•‡∏Ç 2 ‡∏´‡∏•‡∏±‡∏Å (‡πÄ‡∏ä‡πà‡∏ô 26) ‡πÉ‡∏´‡πâ‡πÄ‡∏ï‡∏¥‡∏°‡πÄ‡∏õ‡πá‡∏ô 2026
        if (y < 100) y += 2000;

        dateForInput = `${y}-${m}-${d}`;
      } else {
        // 2. ‡∏ñ‡πâ‡∏≤‡∏Å‡∏£‡∏ì‡∏µ‡πÅ‡∏£‡∏Å‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡∏ú‡∏• ‡∏•‡∏≠‡∏á‡∏™‡∏£‡πâ‡∏≤‡∏á Date Object ‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö (‡πÄ‡∏ú‡∏∑‡πà‡∏≠ Google ‡∏™‡πà‡∏á‡∏°‡∏≤‡πÄ‡∏õ‡πá‡∏ô Serial)
        const dObj = new Date(sheetDate);
        if (!isNaN(dObj.getTime())) {
          let y = dObj.getFullYear();
          if (y > 2500) y -= 543;
          let m = (dObj.getMonth() + 1).toString().padStart(2, '0');
          let d = dObj.getDate().toString().padStart(2, '0');
          dateForInput = `${y}-${m}-${d}`;
        }
      }
    } catch (e) {
      console.error("Date error:", e);
    }
  }
  
  // ‡∏¢‡∏±‡∏î‡∏Ñ‡πà‡∏≤‡∏•‡∏á‡∏ä‡πà‡∏≠‡∏á Input
  document.getElementById('mDeadline').value = dateForInput;
  // ---------------------------------------

  document.getElementById('mOldUrl').value = r[9] || '';
  document.getElementById('mMainCat').value = r[0];
  document.getElementById('mTopicName').value = r[2];
  modal.show();
}

  document.getElementById('editForm').onsubmit = async function(e) {
    e.preventDefault();
    Swal.fire({ title: '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å...', allowOutsideClick: false, didOpen: () => Swal.showLoading() });
    const file = document.getElementById('mFile').files[0];
    const formData = { rowId: document.getElementById('mRowId').value, dept: document.getElementById('mDept').value, staffName: document.getElementById('mStaff').value, status: document.getElementById('mStatus').value, deadline: document.getElementById('mDeadline').value, oldUrl: document.getElementById('mOldUrl').value, mainCat: document.getElementById('mMainCat').value, topicName: document.getElementById('mTopicName').value };
    let fileData = null;
    if(file){
      const reader = new FileReader();
      fileData = await new Promise(resolve => {
        reader.onload = (ev) => resolve({ data: ev.target.result.split(',')[1], mimeType: file.type });
        reader.readAsDataURL(file);
      });
    }
    try {
      await fetch(WEB_APP_URL, { method: 'POST', body: JSON.stringify({ formData, fileData }) });
      modal.hide(); Swal.fire({ icon: 'success', title: '‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à', timer: 1000, showConfirmButton: false });
      loadData();
    } catch (e) { Swal.fire('Error', '‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à', 'error'); }
  };
  window.onload = loadData;

function toggleFilter() {
  const body = document.getElementById('filterBody');
  const icon = document.getElementById('filterIcon');
  if (body.style.display === 'none') {
    body.style.display = 'block';
    icon.innerText = '‡∏õ‡∏¥‡∏î';
    icon.classList.replace('bg-secondary', 'bg-danger');
  } else {
    body.style.display = 'none';
    icon.innerText = '‡πÄ‡∏õ‡∏¥‡∏î‡∏ï‡∏±‡∏ß‡∏Å‡∏£‡∏≠‡∏á';
    icon.classList.replace('bg-danger', 'bg-secondary');
  }
}
const staffModal = new bootstrap.Modal(document.getElementById('staffModal'));

  function showStaffModal() {
    const staffData = {};
    db.criteria.slice(1).forEach(r => {
      const name = (r[6] || '‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏‡∏ä‡∏∑‡πà‡∏≠').trim();
      const status = (r[7] || "").trim();
      if(!staffData[name]) staffData[name] = { total: 0, done: 0 };
      staffData[name].total++;
      if(status === '‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£‡πÅ‡∏•‡πâ‡∏ß') staffData[name].done++;
    });

    staffModal.show();

    setTimeout(() => {
      const ctx = document.getElementById('staffChart').getContext('2d');
      if(window.myChart) window.myChart.destroy();
      
      // ‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô‡∏õ‡∏•‡∏±‡πä‡∏Å‡∏≠‡∏¥‡∏ô‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÅ‡∏™‡∏î‡∏á‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏Ç
      Chart.register(ChartDataLabels);

      window.myChart = new Chart(ctx, {
        type: 'bar',
        data: {
          labels: Object.keys(staffData),
          datasets: [
            { 
              label: '‡∏á‡∏≤‡∏ô‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î', 
              data: Object.values(staffData).map(v => v.total), 
              backgroundColor: '#003366' 
            },
            { 
              label: '‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£‡πÅ‡∏•‡πâ‡∏ß', 
              data: Object.values(staffData).map(v => v.done), 
              backgroundColor: '#198754' 
            }
          ]
        },
        options: {
          indexAxis: 'y',
          responsive: true,
          layout: { padding: { right: 30 } }, // ‡πÄ‡∏ú‡∏∑‡πà‡∏≠‡∏û‡∏∑‡πâ‡∏ô‡∏ó‡∏µ‡πà‡∏î‡πâ‡∏≤‡∏ô‡∏Ç‡∏ß‡∏≤‡πÉ‡∏´‡πâ‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏Ç‡πÑ‡∏°‡πà‡πÇ‡∏î‡∏ô‡∏ï‡∏±‡∏î
          plugins: {
            legend: { position: 'top' },
            datalabels: { // ‡∏Å‡∏≤‡∏£‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏Ç‡∏ö‡∏ô‡πÅ‡∏ó‡πà‡∏á‡∏Å‡∏£‡∏≤‡∏ü
              anchor: 'end',
              align: 'right',
              color: '#444',
              font: { weight: 'bold', size: 12 },
              formatter: (value) => value // ‡πÉ‡∏´‡πâ‡πÅ‡∏™‡∏î‡∏á‡∏Ñ‡πà‡∏≤‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏Ç‡∏≠‡∏≠‡∏Å‡∏°‡∏≤‡∏ï‡∏£‡∏á‡πÜ
            }
          }
        }
      });
    }, 400);
  }

// 1. ‡∏õ‡∏£‡∏∞‡∏Å‡∏≤‡∏®‡∏ï‡∏±‡∏ß‡πÅ‡∏õ‡∏£ Modal ‡πÑ‡∏ß‡πâ‡∏î‡πâ‡∏≤‡∏ô‡∏ö‡∏ô‡∏™‡∏∏‡∏î‡∏Ç‡∏≠‡∏á‡∏™‡πà‡∏ß‡∏ô script (‡∏ñ‡∏±‡∏î‡∏à‡∏≤‡∏Å‡∏ï‡∏±‡∏ß‡πÅ‡∏õ‡∏£ modal ‡πÄ‡∏î‡∏¥‡∏°‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì)
  const viewModal = new bootstrap.Modal(document.getElementById('viewTextModal'));

  // ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡πÄ‡∏î‡∏¥‡∏° ‡πÄ‡∏õ‡πá‡∏ô‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏ô‡∏µ‡πâ‡∏ä‡∏∏‡∏î‡πÄ‡∏î‡∏µ‡∏¢‡∏ß‡∏Ñ‡∏£‡∏±‡∏ö
function showFullText(text) {
  if (!text) return;

  // 1. ‡πÉ‡∏™‡πà‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏•‡∏á‡πÉ‡∏ô‡∏à‡∏∏‡∏î‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏•
  var contentArea = document.getElementById('fullTextContent');
  if (contentArea) {
    contentArea.innerText = text;
  }

  // 2. ‡πÄ‡∏£‡∏µ‡∏¢‡∏Å‡πÄ‡∏õ‡∏¥‡∏î Modal ‡πÇ‡∏î‡∏¢‡∏ï‡∏£‡∏á (‡πÅ‡∏ö‡∏ö‡πÑ‡∏°‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏õ‡∏£‡∏∞‡∏Å‡∏≤‡∏®‡∏ï‡∏±‡∏ß‡πÅ‡∏õ‡∏£‡∏•‡πà‡∏ß‡∏á‡∏´‡∏ô‡πâ‡∏≤)
  var myModalElement = document.getElementById('viewTextModal');
  if (myModalElement) {
    var myModal = new bootstrap.Modal(myModalElement);
    myModal.show();
  } else {
    alert("‡∏´‡∏≤‡∏´‡∏ô‡πâ‡∏≤‡∏ï‡πà‡∏≤‡∏á Modal ‡πÑ‡∏°‡πà‡πÄ‡∏à‡∏≠ ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö ID: viewTextModal");
  }
}
</script>
</body>
</html>